<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Processando Login...</title>

  <link rel="stylesheet" href="./css/login.css" />
</head>
<body>

  <div class="login-overlay"></div>

  <main class="login-container">
    <img src="./assets/logo-obv.png" alt="OBV Clã" class="logo" />
    <h1>Processando login...</h1>
    <p class="subtitle" id="status">Aguarde enquanto validamos suas credenciais.</p>
  </main>

  <script>
    // URL do Google Apps Script (CONFIGURAR)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6Njp0Z39dMtb1_HnNdPgw44cJMwuGkIdCDC0GY2vr9P9qWUpCCcEtDOlnRx7gk2oQDA/exec';

    // Função para obter parâmetros da URL
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      console.log('URL completa:', window.location.href);
      console.log('Search params:', window.location.search);
      console.log('Hash:', window.location.hash);
      return {
        credential: params.get('credential') || getCredentialFromHash()
      };
    }

    // Para modo redirect, o token pode vir no hash
    function getCredentialFromHash() {
      const hash = window.location.hash;
      if (hash) {
        const params = new URLSearchParams(hash.substring(1));
        return params.get('credential') || params.get('id_token');
      }
      return null;
    }

    // Decodificar JWT (básico, só para email)
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    // Processar autenticação
    async function processAuth() {
      const { credential } = getUrlParams();
      const statusEl = document.getElementById('status');

      if (!credential) {
        statusEl.textContent = 'Erro: Token não encontrado. Redirecionando...';
        setTimeout(() => window.location.href = './login.html', 2000);
        return;
      }

      // Decodificar token para obter info básica
      const tokenData = parseJwt(credential);
      
      if (!tokenData) {
        statusEl.textContent = 'Erro ao processar token. Redirecionando...';
        setTimeout(() => window.location.href = './login.html', 2000);
        return;
      }

      try {
        statusEl.textContent = 'Validando com o servidor...';

        // Fazer chamada GET direta (Apps Script aceita melhor GET que POST)
        const checkResponse = await fetch(
          `${APPS_SCRIPT_URL}?action=checkUser&email=${encodeURIComponent(tokenData.email)}`
        ).then(r => r.json());

        console.log('Resposta do servidor:', checkResponse);
        handleAuthResponse(checkResponse, tokenData, credential);

      } catch (error) {
        console.error('Erro na autenticação:', error);
        statusEl.textContent = 'Erro ao conectar com o servidor. Tentando modo offline...';
        
        // FALLBACK: Verificar se usuário já existe no localStorage anterior
        // Ou permitir acesso temporário
        setTimeout(() => {
          alert('Não foi possível conectar ao servidor. Verifique sua conexão e tente novamente.');
          window.location.href = './login.html';
        }, 3000);
      }
    }

    // Tratar resposta da autenticação
    function handleAuthResponse(data, tokenData, credential) {
      const statusEl = document.getElementById('status');

      if (!data.success) {
        statusEl.textContent = data.message || 'Erro na autenticação.';
        setTimeout(() => window.location.href = './login.html', 3000);
        return;
      }

      // Verificar status do usuário
      if (data.status === 'pendente') {
        window.location.href = './aguardando.html';
        return;
      }

      if (data.status === 'rejeitado') {
        statusEl.textContent = 'Seu cadastro foi rejeitado.';
        setTimeout(() => window.location.href = './login.html', 3000);
        return;
      }

      if (data.status === 'aprovado') {
        // Salvar dados no localStorage
        const userData = {
          email: data.email || tokenData.email,
          nome: data.nome || tokenData.name,
          foto: data.foto || tokenData.picture,
          nickname: data.nickname,
          role: data.role || 'membro',
          loginAt: Date.now(), // Timestamp para expiração de sessão
          token: credential, // Para compatibilidade
          authToken: credential // Token para validação no backend
        };

        localStorage.setItem('user', JSON.stringify(userData));

        // Registrar login nos logs (usando GET)
        fetch(`${APPS_SCRIPT_URL}?action=log&email=${encodeURIComponent(userData.email)}&nickname=${encodeURIComponent(userData.nickname)}&evento=login`)
          .catch(() => console.log('Log não registrado'));

        statusEl.textContent = 'Login realizado com sucesso! Redirecionando...';
        setTimeout(() => window.location.href = './index.html', 1000);
        return;
      }

      // Usuário não cadastrado - redirecionar para cadastro
      if (data.status === 'nao_cadastrado') {
        // Salvar dados temporários para o cadastro
        sessionStorage.setItem('tempUser', JSON.stringify({
          email: tokenData.email,
          nome: tokenData.name,
          foto: tokenData.picture
        }));
        window.location.href = './cadastro.html';
        return;
      }
    }

    // Iniciar processo ao carregar página
    processAuth();
  </script>

</body>
</html>
