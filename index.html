<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIKI OBV</title>
    <link rel="icon" type="image/png" href="./assets/logo-obv.png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- ü§ñ Google Gemini AI para busca por imagem -->
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
    
    <!-- üîê PROTE√á√ÉO DE AUTENTICA√á√ÉO -->
    <script>
        // Verificar se est√° logado ANTES de carregar a p√°gina
        const SESSION_EXPIRATION = 8 * 60 * 60 * 1000; // 8 horas
        let user = null;
        try {
            user = JSON.parse(localStorage.getItem('user') || '{}');
        } catch (e) {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
        
        if (!user || !user.email || !(user.authToken || user.token)) {
            // N√£o est√° logado - redirecionar para login
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        } else {
            // Verificar se sess√£o expirou
            const loginAt = user.loginAt || 0;
            if (Date.now() - loginAt > SESSION_EXPIRATION) {
                // Sess√£o expirada - limpar e redirecionar
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }
    </script>
</head>
<body>
    <!-- Header customizado -->
    <div class="top-header" style="position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(20, 25, 50, 0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="./assets/logo-obv.png" alt="OBV" style="height: 40px;" onerror="this.style.display='none'">
            <span style="color: white; font-weight: 600; font-size: 18px;">Wiki-OBV</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 16px;">
            <a href="./admin/admin.html" id="adminLink" style="display: none; color: #9bbcff; text-decoration: none; font-weight: 500; transition: color 0.2s;">Admin</a>
            
            <div id="userDisplay" style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 12px;">
                <img id="userPhoto" src="" alt="User" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                <div style="text-align: left;">
                    <div id="userName" style="color: white; font-weight: 600; font-size: 13px; line-height: 1.2;"></div>
                    <div id="userRole" style="color: rgba(255,255,255,0.7); font-size: 11px; text-transform: uppercase;"></div>
                </div>
            </div>
            
            <button onclick="fazerLogout()" style="background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%); border: none; color: white; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3); transition: all 0.3s ease; font-size: 14px;">
                Sair
            </button>
        </div>
    </div>
    
    <div class="container" style="margin-top: 60px;">
        <!-- Logo do cabe√ßalho -->
        <div style="text-align: center; margin-bottom: 20px; padding: 20px 0;">
            <img src="./assets/logo-obv.png" alt="OBV Logo" style="height: 300px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));" onerror="this.style.display='none'">
        </div>
        
        <div class="tabs-nav">
            <button class="tab-btn active" data-page="pokedex">
                <i class="fas fa-book"></i> Pok√©dex
            </button>
            <button class="tab-btn" data-page="tms">
                <i class="fas fa-compact-disc"></i> TMs
            </button>
            <button class="tab-btn" data-page="tasks">
                <i class="fas fa-tasks"></i> Tasks
            </button>
            <button class="tab-btn" data-page="cla">
                <i class="fas fa-users"></i> CL√É
            </button>
            <button class="tab-btn" id="adminBtn" data-page="admin" style="display:none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-crown"></i> ADMIN
            </button>
        </div>

        <!-- Barra de informa√ß√µes -->
        <div class="stats-bar" style="padding: 12px 24px; background: rgba(20, 25, 50, 0.5); border-radius: 8px; margin: 16px 0; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
            <span><i class="fas fa-database"></i> <span id="pokemonCount">0</span> Pok√©mons</span>
            <span><i class="fas fa-clock"></i> <span id="lastUpdate">--:--</span></span>
            <span><i class="fas fa-bolt" style="color:#ffd700"></i> Busca Instant√¢nea</span>
            <button class="toggle-images-btn" id="toggleImagesBtn" onclick="alternarTipoImagem()" style="margin-left: auto;">
                <i class="fas fa-image"></i> Stickers
            </button>
        </div>

        <!-- Container din√¢mico -->
        <main id="page-content" class="tab-content active">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Carregando...</p>
            </div>
        </main>
        
        <footer>
            <p>DEX OBV ¬© 2023 - Banco de dados Pok√©mon</p>
            <p class="update-info">
                <i class="fas fa-sync-alt"></i> Dados sincronizados do Google Sheets ‚Ä¢ 
                <i class="fas fa-images"></i> Imagens: Pok√©mon Database ‚Ä¢ 
                <i class="fas fa-bolt"></i> Busca Instant√¢nea
            </p>
        </footer>
    </div>
    
    <!-- Core scripts -->
    <script src="js/script.js?v=20260203"></script>
    <script src="js/modules/navigation.js"></script>
    <script src="js/modules/pokedex.js"></script>
    <script src="js/modules/tms.js"></script>
    <script src="js/modules/tasks.js"></script>
    <script src="js/modules/cla.js"></script>
    
    <!-- Sobrescrever fun√ß√£o de logout para o novo sistema de autentica√ß√£o -->
    <script>
        // Sobrescrever a fun√ß√£o antiga do script.js
        window.fazerLogout = function() {
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxZ7bdw1o-1uTM1trZ_ixCakyH9qYM-VG1_mDvyByfzLuTMy-4QzsYalTEMbCfFnLQNg/exec';
            
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Registrar logout nos logs
            if (user.email) {
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'log',
                        email: user.email,
                        nickname: user.nickname,
                        evento: 'logout'
                    })
                }).catch(err => console.error('Erro ao registrar logout:', err));
            }
            
            // Limpar localStorage e sessionStorage
            localStorage.clear();
            sessionStorage.clear();
            
            // Redirecionar para login
            window.location.href = './login.html';
        };
    </script>
    
    <!-- Script para popular informa√ß√µes do usu√°rio no header -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    
                    // Popular informa√ß√µes do header
                    document.getElementById('userPhoto').src = user.foto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.nickname) + '&background=667eea&color=fff';
                    document.getElementById('userName').textContent = user.nome || user.nickname;
                    document.getElementById('userRole').textContent = user.role === 'admin' ? 'ADMIN' : 'MEMBRO';
                    
                    // Mostrar link Admin se for admin
                    if (user.role === 'admin') {
                        document.getElementById('adminLink').style.display = 'block';
                        
                        const adminBtn = document.getElementById('adminBtn');
                        if (adminBtn) {
                            adminBtn.style.display = 'block';
                            adminBtn.addEventListener('click', function() {
                                window.location.href = './admin/admin.html';
                            });
                        }
                    }
                } catch (e) {
                    console.error('Erro ao carregar informa√ß√µes do usu√°rio:', e);
                }
            }
        });
    </script>
</body>
</html>
