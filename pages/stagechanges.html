<!-- Stage Changes - Nova aba do site -->
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<div class="stage-changes-container">
    <h2>Stage Changes</h2>
    <div style="display: flex; gap: 16px; justify-content: center; margin-bottom: 24px;">
        <button id="btnStage" class="tab-btn active" style="min-width: 180px;">Stage Changes</button>
        <button id="btnEffects" class="tab-btn" style="min-width: 180px;">Efeitos</button>
        <button id="btnAtacks" class="tab-btn" style="min-width: 180px;">Atacks</button>
    </div>
    <div id="stagePage" style="display:block;">
                </tbody>
            </table>
        </div>

    </div>
    <div id="effectsPage" style="display:none;">
            <div id="atacksPage" style="display:none;">
                <div class="stage-changes-header" style="margin-bottom: 24px;">
                    <h3>Atacks (Admin Edit√°vel)</h3>
                    <p style="font-size:1.1em;line-height:1.6;">Aqui voc√™ pode visualizar e, se for admin, editar todos os ataques diretamente da planilha.</p>
                </div>
                <div class="stage-changes-table-wrapper" style="overflow-x:auto;">
                    <table class="stage-changes-table" id="atacksTable">
                        <thead>
                            <tr id="atacksTableHead">
                                <!-- Cabe√ßalhos ser√£o preenchidos via JS -->
                            </tr>
                        </thead>
                        <tbody id="atacksTableBody">
                            <!-- Dados ser√£o preenchidos via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        <div class="stage-changes-header" style="margin-bottom: 24px;">
            <h3 style="color:#ff6464;margin-bottom:12px;">‚ö†Ô∏è Efeitos Negativos em Batalha</h3>
            <ul style="font-size:1.1em;line-height:1.6;margin-bottom:18px;">
                <li>‚ùÑÔ∏è <b>Freeze:</b> Paralisa o Pok√©mon por 5 segundos. Se o Pok√©mon retornar para a Pok√©bola, o tempo √© reiniciado.</li>
                <li>‚ö° <b>Paralyze:</b> Paralisa o Pok√©mon por 10 segundos. Se o Pok√©mon retornar para a Pok√©bola, o tempo √© reiniciado.</li>
                <li>üí§ <b>Sleep:</b> O Pok√©mon adormece por 5 segundos. Se o Pok√©mon retornar para a Pok√©bola, o tempo √© reiniciado.</li>
                <li>‚ùå <b>Importante:</b> Esses efeitos n√£o funcionam em Pok√©mon lend√°rios, m√≠ticos ou bosses.</li>
                <li>üõ°Ô∏è <b>Safeguard:</b> A habilidade impede todos os efeitos negativos.</li>
            </ul>
            <h3 style="color:#ffd700;margin-bottom:12px;">‚ù§Ô∏è Recupera√ß√£o</h3>
            <ul style="font-size:1.1em;line-height:1.6;margin-bottom:18px;">
                <li><b>Nurse Joy NPC:</b> Visite um Centro Pok√©mon e fale com a Enfermeira Joy para curar completamente seus Pok√©mon.</li>
                <li><b>Full Heal Potions:</b> Use potions espec√≠ficas para o efeito ou utilize uma Full Heal para curar qualquer condi√ß√£o.</li>
            </ul>
            <h3 style="color:#a0e7ff;margin-bottom:12px;">üß™ Moves que causam Poison</h3>
            <ul style="font-size:1.1em;line-height:1.6;margin-bottom:18px;">
                <li>Toxic ‚Äì 100%</li>
                <li>Poison Sting ‚Äì 30%</li>
                <li>Sludge ‚Äì 30%</li>
                <li>Sludge Bomb ‚Äì 30%</li>
                <li>Cross Poison ‚Äì 10%</li>
                <li>Poison Jab ‚Äì 30%</li>
                <li>Dire Claw ‚Äì 50%</li>
                <li>Poison Fang ‚Äì 50%</li>
                <li>Venoshock ‚Äì N√£o causa Poison (causa 2x de dano se o alvo j√° estiver envenenado)</li>
            </ul>
            <h3 style="color:#ff6464;margin-bottom:12px;">üî• Moves que causam Burn</h3>
            <ul style="font-size:1.1em;line-height:1.6;margin-bottom:18px;">
                <li>Ember ‚Äì 10%</li>
                <li>Flamethrower ‚Äì 10%</li>
                <li>Fire Blast ‚Äì 10%</li>
                <li>Heat Wave ‚Äì 10%</li>
                <li>Flame Wheel ‚Äì 10%</li>
                <li>Flame Charge ‚Äì 10%</li>
                <li>Sacred Fire ‚Äì 50%</li>
                <li>Inferno ‚Äì 100%</li>
                <li>Scald ‚Äì 30%</li>
                <li>Tri Attack ‚Äì 6,67% (entre Burn / Freeze / Paralyze)</li>
                <li>Fire Punch ‚Äì 10%</li>
                <li>Blaze Kick ‚Äì 10%</li>
            </ul>
            <h4 style="color:#ffd700;margin-bottom:8px;">ATEN√á√ÉO OS ATCKS A BAIXO S√ÉO PELA FRANQUIA!</h4>
            <h3 style="color:#88d3ff;margin-bottom:12px;">üí† Moves que causam Freeze</h3>
            <ul style="font-size:1.1em;line-height:1.6;margin-bottom:18px;">
                <li>Blizzard</li>
                <li>Freeze-Dry</li>
                <li>Freezing Glare</li>
                <li>Ice Beam</li>
                <li>Ice Fang</li>
                <li>Ice Punch</li>
                <li>Powder Snow</li>
                <li>Secret Power</li>
                <li>Shadow Chill</li>
                <li>Sheer Cold</li>
                <li>Tri Attack</li>
            </ul>
            <h3 style="color:#ffd700;margin-bottom:12px;">‚ö° Moves que causam Paralysis</h3>
            <ul style="font-size:1.1em;line-height:1.6;margin-bottom:18px;">
                <li>Body Slam</li>
                <li>Bolt Strike</li>
                <li>Bounce</li>
                <li>Buzzy Buzz</li>
                <li>Combat Torque</li>
                <li>Dire Claw</li>
                <li>Discharge</li>
                <li>Dragon Breath</li>
                <li>Fling</li>
                <li>Force Palm</li>
                <li>Freeze Shock</li>
                <li>G-Max Befuddle</li>
                <li>G-Max Stun Shock</li>
                <li>G-Max Volt Crash</li>
                <li>Glare</li>
                <li>Lick</li>
                <li>Nuzzle</li>
                <li>Psycho Shift</li>
                <li>Secret Power</li>
                <li>Shadow Bolt</li>
                <li>Spark</li>
                <li>Splishy Splash</li>
                <li>Stoked Sparksurfer</li>
                <li>Stun Spore</li>
                <li>Thunder</li>
                <li>Thunder Fang</li>
                <li>Thunder Punch</li>
                <li>Thunder Shock</li>
                <li>Thunder Wave</li>
                <li>Thunderbolt</li>
                <li>Tri Attack</li>
                <li>Volt Tackle</li>
                <li>Wildbolt Storm</li>
                <li>Zap Cannon</li>
            </ul>
            <h3 style="color:#a0e7ff;margin-bottom:12px;">üí§ Moves que causam Sleep</h3>
            <ul style="font-size:1.1em;line-height:1.6;margin-bottom:18px;">
                <li>Dark Void</li>
                <li>Dire Claw</li>
                <li>G-Max Befuddle</li>
                <li>G-Max Snooze</li>
                <li>Grass Whistle</li>
                <li>Hypnosis</li>
                <li>Lovely Kiss</li>
                <li>Psycho Shift</li>
                <li>Relic Song</li>
                <li>Rest</li>
                <li>Secret Power</li>
                <li>Sing</li>
                <li>Sleep Powder</li>
                <li>Spore</li>
                <li>Wicked Torque</li>
                <li>Yawn</li>
            </ul>
        </div>
    </div>
    <script>
                // --- FILTROS PARA STAGE CHANGES E EFEITOS ---
                // Reaproveita atacksData se j√° carregado, sen√£o busca
                async function carregarStageOuEfeitos(tipo) {
                    if (!atacksData.length) {
                        try {
                            const resp = await fetch('https://script.google.com/macros/s/AKfycbxCK2_MelvUHTVvvGfvx0M9QfflATDhr4sZjH5nAVgE4kgfvdRo1pFaVGQGZjk_PG5rdg/exec?acao=obter_atacks');
                            const resultado = await resp.json();
                            if (resultado.success && resultado.data && resultado.data.length > 0) {
                                atacksData = resultado.data;
                            } else {
                                alert('Erro ao carregar ataques!');
                                return;
                            }
                        } catch (e) {
                            alert('Erro ao carregar ataques: ' + e.message);
                            return;
                        }
                    }
                    let filtrados = [];
                    if (tipo === 'stage') {
                        filtrados = atacksData.filter(a => (a['A√á√ÉO']||'').toUpperCase() === 'STAGE');
                    } else if (tipo === 'efeitos') {
                        const efeitos = ['POISON','BURN','FREEZE','PARALYSIS','SLEEP'];
                        filtrados = atacksData.filter(a => efeitos.includes((a['A√á√ÉO']||'').toUpperCase()));
                    }
                    renderizarTabelaStageOuEfeitos(tipo, filtrados);
                }

                function renderizarTabelaStageOuEfeitos(tipo, dados) {
                    let tableId = tipo === 'stage' ? 'stageTable' : 'efeitosTable';
                    let table = document.getElementById(tableId);
                    if (!table) {
                        // Criar tabela se n√£o existir
                        const wrapper = document.getElementById(tipo === 'stage' ? 'stagePage' : 'effectsPage');
                        table = document.createElement('table');
                        table.id = tableId;
                        table.className = 'stage-changes-table';
                        wrapper.appendChild(table);
                    }
                    table.innerHTML = '';
                    if (!dados.length) {
                        table.innerHTML = '<tr><td>Nenhum ataque encontrado.</td></tr>';
                        return;
                    }
                    // Cabe√ßalhos
                    const colunas = Object.keys(dados[0]);
                    const thead = document.createElement('thead');
                    const trh = document.createElement('tr');
                    colunas.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col;
                        trh.appendChild(th);
                    });
                    thead.appendChild(trh);
                    table.appendChild(thead);
                    // Corpo
                    const tbody = document.createElement('tbody');
                    dados.forEach(row => {
                        const tr = document.createElement('tr');
                        colunas.forEach(col => {
                            const td = document.createElement('td');
                            td.textContent = row[col];
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    // DataTable
                    if ($.fn.DataTable.isDataTable(table)) {
                        $(table).DataTable().destroy();
                    }
                    $(table).DataTable({
                        responsive: true,
                        pageLength: 25,
                        order: [[0, 'asc']],
                        language: {
                            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                        }
                    });
                }

                // Carregar ao abrir as abas
                document.getElementById('btnStage').addEventListener('click', function() {
                    carregarStageOuEfeitos('stage');
                });
                document.getElementById('btnEffects').addEventListener('click', function() {
                    carregarStageOuEfeitos('efeitos');
                });
        // Script das abas, sem conflito com DataTables
        function setupStageTabs() {
            var btnStage = document.getElementById('btnStage');
            var btnEffects = document.getElementById('btnEffects');
            var btnAtacks = document.getElementById('btnAtacks');
            var stagePage = document.getElementById('stagePage');
            var effectsPage = document.getElementById('effectsPage');
            var atacksPage = document.getElementById('atacksPage');
            if (btnStage && btnEffects && btnAtacks && stagePage && effectsPage && atacksPage) {
                btnStage.onclick = function(e) {
                    e.preventDefault();
                    btnStage.classList.add('active');
                    btnEffects.classList.remove('active');
                    btnAtacks.classList.remove('active');
                    stagePage.style.display = 'block';
                    effectsPage.style.display = 'none';
                    atacksPage.style.display = 'none';
                };
                btnEffects.onclick = function(e) {
                    e.preventDefault();
                    btnEffects.classList.add('active');
                    btnStage.classList.remove('active');
                    btnAtacks.classList.remove('active');
                    stagePage.style.display = 'none';
                    effectsPage.style.display = 'block';
                    atacksPage.style.display = 'none';
                };
                btnAtacks.onclick = function(e) {
                    e.preventDefault();
                    btnAtacks.classList.add('active');
                    btnStage.classList.remove('active');
                    btnEffects.classList.remove('active');
                    stagePage.style.display = 'none';
                    effectsPage.style.display = 'none';
                    atacksPage.style.display = 'block';
                };
            }
        }
        document.addEventListener('DOMContentLoaded', setupStageTabs);
        // --- ABA ATACKS ---
        let atacksTableInstance = null;
        let atacksData = [];

        async function carregarAtacksParaTabela() {
            try {
                const resp = await fetch('https://script.google.com/macros/s/AKfycbxCK2_MelvUHTVvvGfvx0M9QfflATDhr4sZjH5nAVgE4kgfvdRo1pFaVGQGZjk_PG5rdg/exec?acao=obter_atacks');
                const resultado = await resp.json();
                if (resultado.success && resultado.data && resultado.data.length > 0) {
                    atacksData = resultado.data;
                    renderizarTabelaAtacks();
                } else {
                    alert('Erro ao carregar ataques!');
                }
            } catch (e) {
                alert('Erro ao carregar ataques: ' + e.message);
            }
        }

        function isAdmin() {
            try {
                const u = JSON.parse(localStorage.getItem('user') || '{}');
                return !!u && u.role === 'admin';
            } catch (e) { return false; }
        }

        function renderizarTabelaAtacks() {
            const table = document.getElementById('atacksTable');
            if (!table) return;
            // Limpar cabe√ßalho e corpo
            const head = document.getElementById('atacksTableHead');
            const body = document.getElementById('atacksTableBody');
            head.innerHTML = '';
            body.innerHTML = '';
            if (!atacksData.length) return;
            // Cabe√ßalhos din√¢micos
            const colunas = Object.keys(atacksData[0]);
            colunas.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                head.appendChild(th);
            });
            if (isAdmin()) {
                const th = document.createElement('th');
                th.textContent = 'A√ß√µes';
                head.appendChild(th);
            }
            // Linhas
            atacksData.forEach((row, idx) => {
                const tr = document.createElement('tr');
                colunas.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = row[col];
                    if (isAdmin() && col !== 'ATACK') {
                        td.contentEditable = true;
                        td.style.background = 'rgba(255,255,255,0.07)';
                        td.addEventListener('blur', async function() {
                            const novoValor = td.textContent.trim();
                            if (novoValor !== row[col]) {
                                await salvarEdicaoAtack(row['ATACK'], col, novoValor, td);
                            }
                        });
                    }
                    tr.appendChild(td);
                });
                if (isAdmin()) {
                    const tdA = document.createElement('td');
                    tdA.innerHTML = '<span style="color:#ffd700;font-size:1.2em;">‚úîÔ∏è</span>';
                    tr.appendChild(tdA);
                }
                body.appendChild(tr);
            });
            // DataTable
            if (atacksTableInstance) {
                $(table).DataTable().destroy();
            }
            atacksTableInstance = $(table).DataTable({
                responsive: true,
                pageLength: 25,
                order: [[0, 'asc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                }
            });
        }

        async function salvarEdicaoAtack(nomeAtack, campo, valor, td) {
            td.style.background = '#ffe066';
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const resp = await fetch('https://script.google.com/macros/s/AKfycbxCK2_MelvUHTVvvGfvx0M9QfflATDhr4sZjH5nAVgE4kgfvdRo1pFaVGQGZjk_PG5rdg/exec', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'atualizarAtack',
                        nomeAtack,
                        campo,
                        valor,
                        email: user.email,
                        authToken: user.authToken
                    })
                });
                const result = await resp.json();
                if (result.success) {
                    td.style.background = '#b6fcb6';
                    setTimeout(() => td.style.background = 'rgba(255,255,255,0.07)', 800);
                } else {
                    td.style.background = '#ffb3b3';
                    alert('Erro ao salvar: ' + (result.message || 'Falha desconhecida'));
                }
            } catch (e) {
                td.style.background = '#ffb3b3';
                alert('Erro ao salvar: ' + e.message);
            }
        }

        // Carregar ao abrir aba Atacks
        document.getElementById('btnAtacks').addEventListener('click', function() {
            if (!atacksData.length) carregarAtacksParaTabela();
        });
    </script>